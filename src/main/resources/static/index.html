<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
<link href="/jsonTree.css" rel="stylesheet" />
<link href="style.css" rel="stylesheet" type="text/css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<title>Movies</title>
</head>

<body>

	<nav class="navbar navbar-default">
		<div class="container-fluid">

			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>

			<form role="search" class="navbar-form navbar-left" id="search">
				<div class="form-group">
					<input type="text" value="" placeholder="Search for Movie Title"
						class="form-control" name="search">
				</div>
				<button class="btn btn-default" type="submit">Search</button>

			</form>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-default"></div>
			<div class="navbar-brand navbar-center" href="#">Movies</div>

			<div class="navbar-form navbar-right">
				<button class="btn btn-default" onclick="graphMovie2()"
					type="submit">Film Correlati</button>
				<button class="btn btn-default" onclick="showCast()" type="submit">Cast</button>
				<button class="btn btn-default" onclick="showMovieDetails()" type="submit">Dettagli</button>
				<div class="navbar-brand navbar-center"></div>

			</div>
			<div class="navbar-brand navbar-right"></div>
			<div class="navbar-brand navbar-right"></div>

		</div>
	</nav>

	<div class="row" id="row">
		<div class="col-md-5" id="tabella">
			<div class="panel panel-default">
				<div class="panel-heading">Search Results</div>
				<table id="results" class="table table-striped table-hover">
					<thead>
						<tr>
							<th>Movie</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>

	</div>

	<div class="wrapper" id="wrapper"></div>

	<div id="cast-wrapper"></div>

	<script type="text/javascript"
		src="//code.jquery.com/jquery-1.11.0.min.js"></script>

	<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
	<script src="require.js"></script>
	<script src="jsonTree.js"></script>
	<script type="text/javascript">
		var selectedFilm;
		var selectedMovieId;

		$(function() {
			function showMovie(title) {
				$
						.get(
								"/movies/search/findByTitle?title="
										+ encodeURIComponent(title),
								function(data) {
									if (!data)
										return;
									var movie = data;
									$("#title").text(movie.title);
									$("#poster")
											.attr(
													"src",
													"http://neo4j-contrib.github.io/developer-resources/language-guides/assets/posters/"
															+ encodeURIComponent(movie.title)
															+ ".jpg");
									var $list = $("#crew").empty();

								}, "json");
				return false;
			}
			function search() {
				$(document.getElementById("tabella")).show();
				var query = $("#search").find("input[name=search]").val();
				$.get("/movies/search/findByTitleLike?title=*"
						+ encodeURIComponent(query) + "*", function(data) {
					var t = $("table#results tbody").empty();
					if (!data)
						return;
					data = data["_embedded"].movies;
					data
							.forEach(function(movie) {
								$(
										"<tr><td class='movie'>" + movie.title
												+ "</td></tr>").appendTo(t)
										.click(
												function() {
													selectedFilm = $(this)
															.find("td.movie")
															.text()
													graphMovie(selectedFilm);
												})
							});
					showMovie(data[0].title);
				}, "json");
				return false;
			}

			$("#search").submit(search);
			search();
		})

		function graphMovie(movie) {

			clearAll();

			$(document.getElementById("tabella")).hide();

			var width = document.body.clientWidth, height = document.body.scrollHeight;
			active = d3.select(null);

			var force = d3.layout.force().size([ width, height * 1.5 ]).charge(
					-2000).linkDistance(300).on("tick", function tick() {
				link.attr("x1", function(d) {
					return d.source.x;
				}).attr("y1", function(d) {
					return d.source.y;
				}).attr("x2", function(d) {
					return d.target.x;
				}).attr("y2", function(d) {
					return d.target.y;
				});

				node.attr("cx", function(d) {
					return d.x;
				}).attr("cy", function(d) {
					return d.y;
				});

				label.attr("x", function(d) {
					return d.x;
				}).attr("y", function(d) {
					return d.y - 10;
				});
			});

			var drag = force.drag().on("dragstart", function dragstart(d) {
				d3.select(this).classed("fixed", d.fixed = true);
			});

			var svg = d3.select("body").append("svg")
					.attr("width", width * 1.3).attr("height", height * 1.4)

			var g = svg.append("g");

			var link = g.selectAll(".link"), node = g.selectAll(".node"), label = g
					.selectAll(".mytext");

			var zoom = d3.behavior.zoom().scaleExtent([ 1, 8 ]).on(
					"zoom",
					function zoomed() {
						console.log(d3.event)
						g.style("stroke-width", 1.5 / d3.event.scale + "px");
						g.attr("transform", "translate(" + d3.event.translate
								+ ")scale(" + d3.event.scale + ")");
					});

			d3.json("/graph?title=".concat(movie), function(error, graph) {
				if (error)
					return;
				
				selectedMovieId = graph.nodes[0].id
				
				force.nodes(graph.nodes).links(graph.links).start();

				link = link.data(graph.links).enter().append("line").attr(
						"class", "links").style("stroke", "#999");

				node = node.data(graph.nodes).enter().append("circle").attr(
						"class", "node").style("fill", function(d) {
					return '#99FFFF';
				}).attr("class", function(d) {
					return "node " + d.label
				}).attr("r", 40).on("dblclick", function(data) {
					console.log(data)
					graphMovie(data.title);
				}).call(force.drag);

				label = label.data(graph.nodes).enter().append("text").text(
						function(d) {
							return d.title;
						}).style("text-anchor", "middle").style("fill",
						"#000000").style("font-family", "Arial").style(
						"font-size", 20);

			});
		}

		function graphMovie2() {
			graphMovie(selectedFilm);
		}

		function showCast() {
			clearAll();
			
			d3.select("body")
			.append('div')
			.attr("id","cast-wrapper")
			d3.json("/cast?id=".concat(selectedMovieId), function(error, data) {
		        if (error) throw error;

		        var sortAscending = true;
		        var table = d3.select('#cast-wrapper').append('table');
		        var titles = d3.keys(data[0]);
		        var headers = table.append('thead').append('tr')
		            .selectAll('th')
		            .data(titles).enter()
		            .append('th')
		            .text(function (d) {
		                return d;
		            })
		            .on('click', function (d) {
		                headers.attr('class', 'header');

		                if (sortAscending) {
		                    rows.sort(function(a, b) { return b[d] < a[d]; });
		                    sortAscending = false;
		                    this.className = 'aes';
		                } else {
		                    rows.sort(function(a, b) { return b[d] > a[d]; });
		                    sortAscending = true;
		                    this.className = 'des';
		                }

		            });

		        var rows = table.append('tbody').selectAll('tr')
		            .data(data).enter()
		            .append('tr');
		        rows.selectAll('td')
		            .data(function (d) {
		                return titles.map(function (k) {
		                    return { 'value': d[k], 'name': k};
		                });
		            }).enter()
		            .append('td')
		            .attr('data-th', function (d) {
		                return d.name;
		            })
		            .text(function (d) {
		                return d.value;
		            });
		    });
		}
		
		function showMovieDetails() {
			clearAll();
			
			d3.select("body")
			.append('div')
			.attr("id","wrapper")
			
			d3.json("movieDetails?id=".concat(selectedMovieId), function(data){
				function parse(data){

					var wrapper = document.getElementById("wrapper");
//					Get json-data by javascript-object
					var data2 = data
//					or from a string by JSON.parse(str) method
					try {
						var data2 = JSON.parse(data);
					} catch (e) {}
//					Create json-tree
					var tree = jsonTree.create(data2, wrapper);
//					Expand all (or selected) child nodes of root (optional)
					tree.expand(function(node) {
						return node.childNodes.length < 2 || node.label === 'status';
					}) 
			};
			parse(data);
			});
		}
		
		function clearAll() {
			d3.select('#cast-wrapper').remove();
			d3.select("svg").remove();
			d3.select('#wrapper').remove();
		}
		
	</script>
	<script src="http://cdn.jsdelivr.net/g/filesaver.js"></script>

</body>
</html>
