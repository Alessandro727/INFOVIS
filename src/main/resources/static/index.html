<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
<title>Movies</title>
</head>

<body>
	<div id="graph"></div>
	<div role="navigation" class="navbar navbar-default navbar-static-top">
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-md-6">
					<ul class="nav navbar-nav">
						<li>
							<form role="search" class="navbar-form" id="search">
								<div class="form-group">
									<input type="text" value=""
										placeholder="Search for Movie Title" class="form-control"
										name="search">
								</div>
								<button class="btn btn-default" type="submit">Search</button>
							</form>
						</li>
					</ul>
				</div>
				<div class="navbar-header col-sm-6 col-md-6">
					<div class="navbar-brand">
						<div class="brand">Movies</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!--  	<div class="col-md-7">
			<div class="panel panel-default">
				<div class="panel-heading" id="title">Details</div>
				<div class="row">
					<div class="col-sm-4 col-md-4">
						<img src="" class="well" id="poster" />
					</div>
					<div class="col-md-8 col-sm-8">
						<h4>Crew</h4>
						<ul id="crew">
						</ul>
					</div>
				</div>
			</div>
		</div>-->

	<div class="row" id="row">
		<div class="col-md-5" id="tabella">
			<div class="panel panel-default">
				<div class="panel-heading">Search Results</div>
				<table id="results" class="table table-striped table-hover">
					<thead>
						<tr>
							<th>Movie</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>

	</div>
	<style type="text/css">
.node {
	stroke: #222;
	stroke-width: 1.5px;
}

.node.actor {
	fill: #888;
}

.node.movie {
	fill: #BBB;
}

.link {
	stroke: #999;
	stroke-opacity: .6;
	stroke-width: 1px;
}
</style>

	<script type="text/javascript"
		src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		var tabella = null;

		$(function() {
			function showMovie(title) {
				$
						.get(
								"/movies/search/findByTitle?title="
										+ encodeURIComponent(title),
								function(data) {
									if (!data)
										return;
									var movie = data;
									$("#title").text(movie.title);
									$("#poster")
											.attr(
													"src",
													"http://neo4j-contrib.github.io/developer-resources/language-guides/assets/posters/"
															+ encodeURIComponent(movie.title)
															+ ".jpg");
									var $list = $("#crew").empty();

								}, "json");
				return false;
			}
			function search() {
				$(document.getElementById("tabella")).show();
				var query = $("#search").find("input[name=search]").val();
				$
						.get(
								"/movies/search/findByTitleLike?title=*"
										+ encodeURIComponent(query) + "*",
								function(data) {
									var t = $("table#results tbody").empty();
									if (!data)
										return;
									data = data["_embedded"].movies;
									data
											.forEach(function(movie) {
												$(
														"<tr><td class='movie'>"
																+ movie.title
																+ "</td></tr>")
														.appendTo(t)
														.click(
																function() {
																	graphMovie($(
																			this)
																			.find(
																					"td.movie")
																			.text());
																})
											});
									showMovie(data[0].title);
								}, "json");
				return false;
			}

			$("#search").submit(search);
			search();
		})

		function graphMovie(movie) {

			deleteGraph();

			$(document.getElementById("tabella")).hide();

			var width = document.body.clientWidth, height = document.body.scrollHeight;
			active = d3.select(null);

			var force = d3.layout.force().size([ width, height * 1.5 ]).charge(
					-2000).linkDistance(300).on("tick", function tick() {
				link.attr("x1", function(d) {
					return d.source.x;
				}).attr("y1", function(d) {
					return d.source.y;
				}).attr("x2", function(d) {
					return d.target.x;
				}).attr("y2", function(d) {
					return d.target.y;
				});

				node.attr("cx", function(d) {
					return d.x;
				}).attr("cy", function(d) {
					return d.y;
				});

				label.attr("x", function(d) {
					return d.x;
				}).attr("y", function(d) {
					return d.y - 10;
				});
			});

			var drag = force.drag().on("dragstart", function dragstart(d) {
				d3.select(this).classed("fixed", d.fixed = true);
			});

			var svg = d3.select("#graph").append("svg").attr("width",
					width * 1.3).attr("height", height * 1.4)
			// .on("click", reset);

			var g = svg.append("g");

			var link = g.selectAll(".link"), node = g.selectAll(".node"), label = g
					.selectAll(".mytext");

			var zoom = d3.behavior.zoom().scaleExtent([ 1, 8 ]).on(
					"zoom",
					function zoomed() {
						console.log(d3.event)
						g.style("stroke-width", 1.5 / d3.event.scale + "px");
						g.attr("transform", "translate(" + d3.event.translate
								+ ")scale(" + d3.event.scale + ")");
					});

			//svg.call(zoom) // delete this line to disable free zooming
			//.call(zoom.event);

			d3.json("/graph?title=".concat(movie), function(error, graph) {
				if (error)
					return;

				force.nodes(graph.nodes).links(graph.links).start();

				link = link.data(graph.links).enter().append("line").attr(
						"class", "links").style("stroke", "#999");

				node = node.data(graph.nodes).enter().append("circle").attr(
						"class", "node").style("fill", function(d) {
					return '#99FFFF';
				}).attr("class", function(d) {
					return "node " + d.label
				}).attr("r", 40).on("dblclick", function(data) {
					console.log(data)
					graphMovie(data.title);
				}).call(force.drag);

				label = label.data(graph.nodes).enter().append("text").text(
						function(d) {
							return d.title;
						}).style("text-anchor", "middle").style("fill",
						"#000000").style("font-family", "Arial").style(
						"font-size", 20);

			});
		}

		function deleteGraph() {
			d3.select("svg").remove();
		}
	</script>
</body>
</html>
